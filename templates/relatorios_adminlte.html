<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PromoPreço | Relatórios</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/" class="nav-link">Dashboard</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/cadastros" class="nav-link">Cadastros</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/relatorios" class="nav-link">Relatórios</a>
            </li>
        </ul>
    </nav>

    <!-- Sidebar -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="/" class="brand-link">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzMiIGhlaWdodD0iMzMiIHZpZXdCb3g9IjAgMCAzMyAzMyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMzIiBoZWlnaHQ9IjMzIiByeD0iNSIgZmlsbD0iIzM0OThkYiIvPgo8dGV4dCB4PSIxNi41IiB5PSIyMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+wqQ8L3RleHQ+Cjwvc3ZnPg==" alt="PromoPreço Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
            <span class="brand-text font-weight-light">PromoPreço</span>
        </a>

        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                    <li class="nav-item">
                        <a href="/cadastros" class="nav-link">
                            <i class="nav-icon fas fa-plus-circle"></i>
                            <p>Cadastros</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/" class="nav-link">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link active">
                            <i class="nav-icon fas fa-file-alt"></i>
                            <p>Relatórios</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Relatórios</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item active">Relatórios</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                
                <!-- Filtros -->
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-filter"></i> Filtros</h3>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="periodo">Período</label>
                                    <select class="form-control" id="periodo" onchange="atualizarPeriodo()">
                                        <option value="7">Últimos 7 dias</option>
                                        <option value="30">Últimos 30 dias</option>
                                        <option value="90">Últimos 90 dias</option>
                                        <option value="custom">Personalizado</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3" id="periodo-custom" style="display: none;">
                                <div class="form-group">
                                    <label for="daterange">Data Personalizada</label>
                                    <input type="text" class="form-control" id="daterange" name="daterange">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="produto-filtro">Produto</label>
                                    <select class="form-control" id="produto-filtro">
                                        <option value="">Todos os produtos</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="estabelecimento-filtro">Estabelecimento</label>
                                    <select class="form-control" id="estabelecimento-filtro">
                                        <option value="">Todos os estabelecimentos</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary" onclick="gerarRelatorio()">
                                    <i class="fas fa-chart-bar"></i> Gerar Relatório
                                </button>
                                <div class="btn-group ml-2">
                                    <button type="button" class="btn btn-success dropdown-toggle" data-toggle="dropdown">
                                        <i class="fas fa-download"></i> Exportar
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#" onclick="exportarRelatorio('csv')">
                                            <i class="fas fa-file-csv"></i> CSV
                                        </a>
                                        <a class="dropdown-item" href="#" onclick="exportarRelatorio('excel')">
                                            <i class="fas fa-file-excel"></i> Excel
                                        </a>
                                        <a class="dropdown-item" href="#" onclick="exportarRelatorio('pdf')">
                                            <i class="fas fa-file-pdf"></i> PDF
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estatísticas -->
                <div class="row" id="estatisticas-cards" style="display: none;">
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-info">
                            <div class="inner">
                                <h3 id="total-registros">-</h3>
                                <p>Registros de Preços</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-tags"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-success">
                            <div class="inner">
                                <h3 id="preco-medio">-</h3>
                                <p>Preço Médio</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-warning">
                            <div class="inner">
                                <h3 id="menor-preco">-</h3>
                                <p>Menor Preço</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-6">
                        <div class="small-box bg-danger">
                            <div class="inner">
                                <h3 id="maior-preco">-</h3>
                                <p>Maior Preço</p>
                            </div>
                            <div class="icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row" id="graficos-section" style="display: none;">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-line"></i>
                                    Evolução de Preços
                                </h3>
                            </div>
                            <div class="card-body">
                                <canvas id="grafico-evolucao" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <i class="fas fa-chart-pie"></i>
                                    Distribuição por Estabelecimento
                                </h3>
                            </div>
                            <div class="card-body">
                                <canvas id="grafico-estabelecimentos" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Dados -->
                <div class="card" id="tabela-dados" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-table"></i>
                            Dados Detalhados
                        </h3>
                        <div class="card-tools">
                            <div class="input-group input-group-sm" style="width: 200px;">
                                <input type="text" name="table_search" class="form-control float-right" placeholder="Buscar" id="busca-tabela">
                                <div class="input-group-append">
                                    <button type="submit" class="btn btn-default">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body table-responsive p-0">
                        <table class="table table-hover text-nowrap" id="tabela-relatorio">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Estabelecimento</th>
                                    <th>Bairro</th>
                                    <th>Preço</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody id="dados-tabela">
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-sm-12 col-md-5">
                                <div class="dataTables_info" id="info-paginacao"></div>
                            </div>
                            <div class="col-sm-12 col-md-7">
                                <div class="dataTables_paginate paging_simple_numbers" id="paginacao"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <strong>Copyright &copy; 2024 <a href="#">PromoPreço</a>.</strong>
        Sistema de comparação de preços.
        <div class="float-right d-none d-sm-inline-block">
            <b>Versão</b> 1.0.0
        </div>
    </footer>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let dadosRelatorio = [];
    let paginaAtual = 1;
    let itensPorPagina = 20;

    $(document).ready(function() {
        carregarFiltros();
        configurarDateRange();
        configurarBusca();
    });

    function configurarDateRange() {
        $('#daterange').daterangepicker({
            opens: 'left',
            locale: {
                format: 'DD/MM/YYYY',
                separator: ' - ',
                applyLabel: 'Aplicar',
                cancelLabel: 'Cancelar',
                fromLabel: 'De',
                toLabel: 'Até',
                customRangeLabel: 'Personalizado',
                weekLabel: 'S',
                daysOfWeek: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
                firstDay: 1
            }
        });
    }

    function configurarBusca() {
        let timeoutBusca = null;
        $('#busca-tabela').on('input', function() {
            const termo = $(this).val().trim();
            
            if (timeoutBusca) {
                clearTimeout(timeoutBusca);
            }
            
            timeoutBusca = setTimeout(() => {
                filtrarTabela(termo);
            }, 300);
        });
    }

    function atualizarPeriodo() {
        const periodo = $('#periodo').val();
        if (periodo === 'custom') {
            $('#periodo-custom').show();
        } else {
            $('#periodo-custom').hide();
        }
    }

    async function carregarFiltros() {
        try {
            const [produtosResp, estabelecimentosResp] = await Promise.all([
                fetch('/produtos'),
                fetch('/estabelecimentos')
            ]);
            
            const produtos = await produtosResp.json();
            const estabelecimentos = await estabelecimentosResp.json();
            
            const selectProduto = $('#produto-filtro');
            produtos.forEach(p => {
                selectProduto.append(`<option value="${p.id}">${p.descricao}</option>`);
            });

            const selectEstab = $('#estabelecimento-filtro');
            estabelecimentos.forEach(e => {
                selectEstab.append(`<option value="${e.id}">${e.nome}</option>`);
            });
            
        } catch (error) {
            console.error('Erro ao carregar filtros:', error);
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro ao carregar filtros',
                autohide: true,
                delay: 5000
            });
        }
    }

    async function gerarRelatorio() {
        try {
            const periodo = $('#periodo').val();
            const produtoId = $('#produto-filtro').val();
            const estabelecimentoId = $('#estabelecimento-filtro').val();
            
            let dias = periodo;
            if (periodo === 'custom') {
                const dateRange = $('#daterange').val();
                if (!dateRange) {
                    $(document).Toasts('create', {
                        class: 'bg-warning',
                        title: 'Atenção',
                        body: 'Selecione um período personalizado',
                        autohide: true,
                        delay: 3000
                    });
                    return;
                }
                // Para simplificar, vamos usar 30 dias para período personalizado
                dias = 30;
            }
            
            let url = `/api/relatorio-precos?dias=${dias}`;
            if (produtoId) url += `&produto_id=${produtoId}`;
            if (estabelecimentoId) url += `&estabelecimento_id=${estabelecimentoId}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error('Erro ao gerar relatório');
            }
            
            dadosRelatorio = await response.json();
            
            if (dadosRelatorio.length === 0) {
                $(document).Toasts('create', {
                    class: 'bg-info',
                    title: 'Informação',
                    body: 'Nenhum dado encontrado para os filtros selecionados',
                    autohide: true,
                    delay: 3000
                });
                return;
            }
            
            exibirEstatisticas();
            exibirGraficos();
            exibirTabela();
            
            $('#estatisticas-cards').show();
            $('#graficos-section').show();
            $('#tabela-dados').show();
            
        } catch (error) {
            console.error('Erro ao gerar relatório:', error);
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro ao gerar relatório',
                autohide: true,
                delay: 5000
            });
        }
    }

    function exibirEstatisticas() {
        const precos = dadosRelatorio.map(d => d.preco);
        const total = precos.length;
        const soma = precos.reduce((a, b) => a + b, 0);
        const media = soma / total;
        const menor = Math.min(...precos);
        const maior = Math.max(...precos);
        
        $('#total-registros').text(total);
        $('#preco-medio').text(`R$ ${media.toFixed(2)}`);
        $('#menor-preco').text(`R$ ${menor.toFixed(2)}`);
        $('#maior-preco').text(`R$ ${maior.toFixed(2)}`);
    }

    function exibirGraficos() {
        // Gráfico de evolução de preços
        const ctx1 = document.getElementById('grafico-evolucao').getContext('2d');
        
        // Agrupar dados por data
        const dadosPorData = {};
        dadosRelatorio.forEach(item => {
            const data = item.data_coleta.split(' ')[0];
            if (!dadosPorData[data]) {
                dadosPorData[data] = [];
            }
            dadosPorData[data].push(item.preco);
        });
        
        const labels = Object.keys(dadosPorData).sort();
        const precosMedios = labels.map(data => {
            const precos = dadosPorData[data];
            return precos.reduce((a, b) => a + b, 0) / precos.length;
        });
        
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Preço Médio',
                    data: precosMedios,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                return 'R$ ' + value.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
        
        // Gráfico de estabelecimentos
        const ctx2 = document.getElementById('grafico-estabelecimentos').getContext('2d');
        
        const estabelecimentos = {};
        dadosRelatorio.forEach(item => {
            if (!estabelecimentos[item.estabelecimento]) {
                estabelecimentos[item.estabelecimento] = 0;
            }
            estabelecimentos[item.estabelecimento]++;
        });
        
        const labelsEstab = Object.keys(estabelecimentos);
        const valoresEstab = Object.values(estabelecimentos);
        
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: labelsEstab,
                datasets: [{
                    data: valoresEstab,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF',
                        '#FF9F40'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function exibirTabela() {
        paginaAtual = 1;
        renderizarTabela();
    }

    function renderizarTabela() {
        const inicio = (paginaAtual - 1) * itensPorPagina;
        const fim = inicio + itensPorPagina;
        const dadosPagina = dadosRelatorio.slice(inicio, fim);
        
        const tbody = $('#dados-tabela');
        tbody.empty();
        
        dadosPagina.forEach(item => {
            const row = `
                <tr>
                    <td>${item.produto}</td>
                    <td>${item.estabelecimento}</td>
                    <td>${item.bairro}</td>
                    <td>R$ ${item.preco.toFixed(2)}</td>
                    <td>${item.data_coleta}</td>
                </tr>
            `;
            tbody.append(row);
        });
        
        atualizarPaginacao();
    }

    function atualizarPaginacao() {
        const totalPaginas = Math.ceil(dadosRelatorio.length / itensPorPagina);
        const inicio = (paginaAtual - 1) * itensPorPagina + 1;
        const fim = Math.min(paginaAtual * itensPorPagina, dadosRelatorio.length);
        
        $('#info-paginacao').text(`Mostrando ${inicio} a ${fim} de ${dadosRelatorio.length} registros`);
        
        const paginacao = $('#paginacao');
        paginacao.empty();
        
        if (totalPaginas > 1) {
            let html = '<ul class="pagination pagination-sm m-0 float-right">';
            
            // Anterior
            if (paginaAtual > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${paginaAtual - 1})">«</a></li>`;
            }
            
            // Páginas
            for (let i = 1; i <= totalPaginas; i++) {
                if (i === paginaAtual) {
                    html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
                } else {
                    html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${i})">${i}</a></li>`;
                }
            }
            
            // Próximo
            if (paginaAtual < totalPaginas) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="irParaPagina(${paginaAtual + 1})">»</a></li>`;
            }
            
            html += '</ul>';
            paginacao.html(html);
        }
    }

    function irParaPagina(pagina) {
        paginaAtual = pagina;
        renderizarTabela();
    }

    function filtrarTabela(termo) {
        if (!termo) {
            renderizarTabela();
            return;
        }
        
        const dadosFiltrados = dadosRelatorio.filter(item => 
            item.produto.toLowerCase().includes(termo.toLowerCase()) ||
            item.estabelecimento.toLowerCase().includes(termo.toLowerCase()) ||
            item.bairro.toLowerCase().includes(termo.toLowerCase())
        );
        
        const tbody = $('#dados-tabela');
        tbody.empty();
        
        dadosFiltrados.forEach(item => {
            const row = `
                <tr>
                    <td>${item.produto}</td>
                    <td>${item.estabelecimento}</td>
                    <td>${item.bairro}</td>
                    <td>R$ ${item.preco.toFixed(2)}</td>
                    <td>${item.data_coleta}</td>
                </tr>
            `;
            tbody.append(row);
        });
        
        $('#info-paginacao').text(`${dadosFiltrados.length} registros encontrados`);
        $('#paginacao').empty();
    }

    async function exportarRelatorio(formato) {
        if (dadosRelatorio.length === 0) {
            $(document).Toasts('create', {
                class: 'bg-warning',
                title: 'Atenção',
                body: 'Gere um relatório antes de exportar',
                autohide: true,
                delay: 3000
            });
            return;
        }
        
        try {
            const periodo = $('#periodo').val();
            const produtoId = $('#produto-filtro').val();
            const estabelecimentoId = $('#estabelecimento-filtro').val();
            
            let url = `/api/relatorio-precos?formato=${formato}&dias=${periodo}`;
            if (produtoId) url += `&produto_id=${produtoId}`;
            if (estabelecimentoId) url += `&estabelecimento_id=${estabelecimentoId}`;
            
            window.open(url, '_blank');
            
        } catch (error) {
            console.error('Erro ao exportar:', error);
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro ao exportar relatório',
                autohide: true,
                delay: 5000
            });
        }
    }
</script>
</body>
</html>