<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PromoPreço | Cadastros</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">
    <!-- Navbar -->
    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/" class="nav-link">Dashboard</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/cadastros" class="nav-link">Cadastros</a>
            </li>
            <li class="nav-item d-none d-sm-inline-block">
                <a href="/relatorios" class="nav-link">Relatórios</a>
            </li>
        </ul>
    </nav>

    <!-- Sidebar -->
    <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <a href="/" class="brand-link">
            <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzMiIGhlaWdodD0iMzMiIHZpZXdCb3g9IjAgMCAzMyAzMyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMzIiBoZWlnaHQ9IjMzIiByeD0iNSIgZmlsbD0iIzM0OThkYiIvPgo8dGV4dCB4PSIxNi41IiB5PSIyMCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+wqQ8L3RleHQ+Cjwvc3ZnPg==" alt="PromoPreço Logo" class="brand-image img-circle elevation-3" style="opacity: .8">
            <span class="brand-text font-weight-light">PromoPreço</span>
        </a>

        <div class="sidebar">
            <nav class="mt-2">
                <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
                    <li class="nav-item">
                        <a href="#" class="nav-link active">
                            <i class="nav-icon fas fa-plus-circle"></i>
                            <p>Cadastros</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/" class="nav-link">
                            <i class="nav-icon fas fa-tachometer-alt"></i>
                            <p>Dashboard</p>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="/relatorios" class="nav-link">
                            <i class="nav-icon fas fa-file-alt"></i>
                            <p>Relatórios</p>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    </aside>

    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">Cadastros</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item active">Cadastros</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <!-- Nav tabs -->
                <div class="card card-primary card-tabs">
                    <div class="card-header p-0 pt-1">
                        <ul class="nav nav-tabs" id="custom-tabs-one-tab" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link active" id="produtos-tab" data-toggle="pill" href="#produtos" role="tab">
                                    <i class="fas fa-box"></i> Produtos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="estabelecimentos-tab" data-toggle="pill" href="#estabelecimentos" role="tab">
                                    <i class="fas fa-store"></i> Estabelecimentos
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="precos-tab" data-toggle="pill" href="#precos" role="tab">
                                    <i class="fas fa-tags"></i> Preços
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" id="consultas-tab" data-toggle="pill" href="#consultas" role="tab">
                                    <i class="fas fa-search"></i> Consultas
                                </a>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="custom-tabs-one-tabContent">
                            
                            <!-- Produtos Tab -->
                            <div class="tab-pane fade show active" id="produtos" role="tabpanel">
                                <div class="card card-info">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-box"></i> Cadastro de Produtos</h3>
                                    </div>
                                    <form id="formProduto" class="form-horizontal">
                                        <div class="card-body">
                                            <div class="form-group row">
                                                <label for="descricao" class="col-sm-2 col-form-label">Descrição</label>
                                                <div class="col-sm-10">
                                                    <input type="text" class="form-control" id="descricao" name="descricao" required>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="ean" class="col-sm-2 col-form-label">EAN</label>
                                                <div class="col-sm-10">
                                                    <input type="text" class="form-control" id="ean" name="ean" placeholder="0000000000000" maxlength="13">
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <button type="submit" class="btn btn-info">
                                                <i class="fas fa-save"></i> Cadastrar Produto
                                            </button>
                                        </div>
                                    </form>
                                    <div id="msgProduto"></div>
                                </div>
                            </div>

                            <!-- Estabelecimentos Tab -->
                            <div class="tab-pane fade" id="estabelecimentos" role="tabpanel">
                                <div class="card card-success">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-store"></i> Cadastro de Estabelecimentos</h3>
                                    </div>
                                    <form id="formEstabelecimento" class="form-horizontal">
                                        <div class="card-body">
                                            <div class="form-group row">
                                                <label for="nome" class="col-sm-2 col-form-label">Nome</label>
                                                <div class="col-sm-10">
                                                    <input type="text" class="form-control" id="nome" name="nome" required>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="cnpj" class="col-sm-2 col-form-label">CNPJ</label>
                                                <div class="col-sm-10">
                                                    <input type="text" class="form-control" id="cnpj" name="cnpj" placeholder="00.000.000/0000-00" maxlength="18">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="bairro" class="col-sm-2 col-form-label">Bairro</label>
                                                <div class="col-sm-10">
                                                    <input type="text" class="form-control" id="bairro" name="bairro" required>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="cidade" class="col-sm-2 col-form-label">Cidade</label>
                                                <div class="col-sm-10">
                                                    <input type="text" class="form-control" id="cidade" name="cidade" required>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save"></i> Cadastrar Estabelecimento
                                            </button>
                                        </div>
                                    </form>
                                    <div id="msgEstabelecimento"></div>
                                </div>
                            </div>

                            <!-- Preços Tab -->
                            <div class="tab-pane fade" id="precos" role="tabpanel">
                                <div class="card card-warning">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-tags"></i> Cadastro de Preços</h3>
                                    </div>
                                    <form id="formPreco" class="form-horizontal">
                                        <div class="card-body">
                                            <div class="form-group row">
                                                <label for="busca_produto" class="col-sm-2 col-form-label">Buscar Produto</label>
                                                <div class="col-sm-10">
                                                    <input type="text" class="form-control" id="busca_produto" placeholder="Digite para buscar produto..." autocomplete="off">
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="produto_id" class="col-sm-2 col-form-label">Produto</label>
                                                <div class="col-sm-10">
                                                    <select class="form-control" id="produto_id" name="produto_id" required>
                                                        <option value="">Selecione um produto</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="estabelecimento_id" class="col-sm-2 col-form-label">Estabelecimento</label>
                                                <div class="col-sm-10">
                                                    <select class="form-control" id="estabelecimento_id" name="estabelecimento_id" required>
                                                        <option value="">Selecione um estabelecimento</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="form-group row">
                                                <label for="preco" class="col-sm-2 col-form-label">Preço</label>
                                                <div class="col-sm-10">
                                                    <div class="input-group">
                                                        <div class="input-group-prepend">
                                                            <span class="input-group-text">R$</span>
                                                        </div>
                                                        <input type="number" class="form-control" id="preco" name="preco" step="0.01" min="0.01" placeholder="0.00" required>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-footer">
                                            <button type="submit" class="btn btn-warning">
                                                <i class="fas fa-save"></i> Cadastrar Preço
                                            </button>
                                        </div>
                                    </form>
                                    <div id="msgPreco"></div>
                                </div>
                            </div>

                            <!-- Consultas Tab -->
                            <div class="tab-pane fade" id="consultas" role="tabpanel">
                                <div class="card card-secondary">
                                    <div class="card-header">
                                        <h3 class="card-title"><i class="fas fa-search"></i> Consultar Cadastros</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="tipoBusca">Tipo de Cadastro</label>
                                                    <select class="form-control" id="tipoBusca" onchange="carregarListagem()">
                                                        <option value="">Selecione o tipo</option>
                                                        <option value="produtos">Produtos</option>
                                                        <option value="estabelecimentos">Estabelecimentos</option>
                                                        <option value="precos">Preços</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="busca">Buscar</label>
                                                    <input type="text" class="form-control" id="busca" placeholder="Digite para buscar..." oninput="filtrarListagem()" autocomplete="off">
                                                </div>
                                            </div>
                                        </div>
                                        <div id="listagemContainer"></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Footer -->
    <footer class="main-footer">
        <strong>Copyright &copy; 2024 <a href="#">PromoPreço</a>.</strong>
        Sistema de comparação de preços.
        <div class="float-right d-none d-sm-inline-block">
            <b>Versão</b> 1.0.0
        </div>
    </footer>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

<script>
    let todosProdutos = [];
    let timeoutBuscaProduto = null;
    let dadosAtuais = [];

    $(document).ready(function() {
        carregarDados();
    });

    // Máscaras
    $('#cnpj').on('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{2})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1.$2');
        value = value.replace(/(\d{3})(\d)/, '$1/$2');
        value = value.replace(/(\d{4})(\d)/, '$1-$2');
        e.target.value = value.substring(0, 18);
    });

    $('#ean').on('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '').substring(0, 13);
    });

    // Busca de produtos
    $('#busca_produto').on('input', function() {
        const termo = $(this).val().trim();
        
        if (timeoutBuscaProduto) {
            clearTimeout(timeoutBuscaProduto);
        }
        
        timeoutBuscaProduto = setTimeout(() => {
            buscarProdutos(termo);
        }, 300);
    });

    async function carregarDados() {
        try {
            const [produtosResp, estabelecimentosResp] = await Promise.all([
                fetch('/produtos'),
                fetch('/estabelecimentos')
            ]);
            
            const produtos = await produtosResp.json();
            const estabelecimentos = await estabelecimentosResp.json();
            
            todosProdutos = produtos;
            
            // Popular selects
            const selectProduto = $('#produto_id');
            selectProduto.html('<option value="">Selecione um produto</option>');
            produtos.forEach(p => {
                selectProduto.append(`<option value="${p.id}">${p.id} - ${p.descricao}</option>`);
            });

            const selectEstab = $('#estabelecimento_id');
            selectEstab.html('<option value="">Selecione um estabelecimento</option>');
            estabelecimentos.forEach(e => {
                selectEstab.append(`<option value="${e.id}">${e.nome}</option>`);
            });
            
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro ao carregar dados iniciais',
                autohide: true,
                delay: 5000
            });
        }
    }

    async function buscarProdutos(termo) {
        if (!termo || termo.length < 2) {
            atualizarSelectProdutos(todosProdutos);
            return;
        }
        
        try {
            const response = await fetch(`/produtos?q=${encodeURIComponent(termo)}`);
            if (response.ok) {
                const produtos = await response.json();
                atualizarSelectProdutos(produtos);
            }
        } catch (error) {
            console.error('Erro na busca:', error);
        }
    }

    function atualizarSelectProdutos(produtos) {
        const select = $('#produto_id');
        const valorAtual = select.val();
        
        select.html('<option value="">Selecione um produto</option>');
        produtos.forEach(p => {
            select.append(`<option value="${p.id}">${p.id} - ${p.descricao}</option>`);
        });
        
        if (valorAtual && produtos.find(p => p.id == valorAtual)) {
            select.val(valorAtual);
        }
    }

    // Formulários
    $('#formProduto').on('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        const editId = this.dataset.editId;
        
        try {
            const url = editId ? `/produtos/${editId}` : '/produtos';
            const method = editId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                const msg = editId ? 'Produto atualizado!' : 'Produto cadastrado!';
                $(document).Toasts('create', {
                    class: 'bg-success',
                    title: 'Sucesso',
                    body: msg,
                    autohide: true,
                    delay: 3000
                });
                this.reset();
                delete this.dataset.editId;
                carregarDados();
            } else {
                $(document).Toasts('create', {
                    class: 'bg-danger',
                    title: 'Erro',
                    body: result.error || 'Erro ao salvar produto',
                    autohide: true,
                    delay: 5000
                });
            }
        } catch (error) {
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro de conexão',
                autohide: true,
                delay: 5000
            });
        }
    });

    $('#formEstabelecimento').on('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        const editId = this.dataset.editId;
        
        try {
            const url = editId ? `/estabelecimentos/${editId}` : '/estabelecimentos';
            const method = editId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                const msg = editId ? 'Estabelecimento atualizado!' : 'Estabelecimento cadastrado!';
                $(document).Toasts('create', {
                    class: 'bg-success',
                    title: 'Sucesso',
                    body: msg,
                    autohide: true,
                    delay: 3000
                });
                this.reset();
                delete this.dataset.editId;
                carregarDados();
            } else {
                $(document).Toasts('create', {
                    class: 'bg-danger',
                    title: 'Erro',
                    body: result.error || 'Erro ao salvar estabelecimento',
                    autohide: true,
                    delay: 5000
                });
            }
        } catch (error) {
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro de conexão',
                autohide: true,
                delay: 5000
            });
        }
    });

    $('#formPreco').on('submit', async function(e) {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(this));
        const editId = this.dataset.editId;
        
        try {
            const url = editId ? `/precos/${editId}` : '/precos';
            const method = editId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                const msg = editId ? 'Preço atualizado!' : 'Preço cadastrado!';
                $(document).Toasts('create', {
                    class: 'bg-success',
                    title: 'Sucesso',
                    body: msg,
                    autohide: true,
                    delay: 3000
                });
                this.reset();
                delete this.dataset.editId;
            } else {
                $(document).Toasts('create', {
                    class: 'bg-danger',
                    title: 'Erro',
                    body: result.error || 'Erro ao salvar preço',
                    autohide: true,
                    delay: 5000
                });
            }
        } catch (error) {
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro de conexão',
                autohide: true,
                delay: 5000
            });
        }
    });

    // Consultas
    async function carregarListagem() {
        const tipo = $('#tipoBusca').val();
        const container = $('#listagemContainer');
        
        if (!tipo) {
            container.html('');
            return;
        }
        
        $('#busca').val('');
        
        try {
            container.html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>');
            await carregarListagemComBusca(tipo, '');
        } catch (error) {
            container.html('<div class="alert alert-danger">Erro ao carregar dados</div>');
        }
    }

    async function carregarListagemComBusca(tipo, busca) {
        try {
            let url;
            if (tipo === 'precos') {
                url = `/precos/detalhados?per_page=50${busca ? `&q=${encodeURIComponent(busca)}` : ''}`;
            } else {
                url = `/${tipo}${busca ? `?q=${encodeURIComponent(busca)}` : ''}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (tipo === 'precos') {
                dadosAtuais = data.precos || [];
            } else {
                dadosAtuais = data;
            }
            
            exibirListagem(dadosAtuais, tipo, busca);
        } catch (error) {
            throw error;
        }
    }

    function exibirListagem(dados, tipo, termoBusca = '') {
        const container = $('#listagemContainer');
        
        if (dados.length === 0) {
            container.html('<div class="alert alert-info">Nenhum registro encontrado</div>');
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-striped table-hover"><thead class="thead-dark"><tr>';
        
        if (tipo === 'produtos') {
            html += '<th>ID</th><th>Descrição</th><th>EAN</th><th>Ações</th>';
        } else if (tipo === 'estabelecimentos') {
            html += '<th>ID</th><th>Nome</th><th>CNPJ</th><th>Bairro</th><th>Cidade</th><th>Ações</th>';
        } else if (tipo === 'precos') {
            html += '<th>ID</th><th>Produto</th><th>Estabelecimento</th><th>Preço</th><th>Data</th><th>Ações</th>';
        }
        
        html += '</tr></thead><tbody>';
        
        dados.forEach(item => {
            html += '<tr>';
            if (tipo === 'produtos') {
                html += `<td>${item.id}</td><td>${item.descricao}</td><td>${item.ean || ''}</td>`;
                html += `<td>
                    <button class="btn btn-sm btn-warning" onclick="editarItem('${tipo}', ${item.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger ml-1" onclick="excluirItem('${tipo}', ${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>`;
            } else if (tipo === 'estabelecimentos') {
                html += `<td>${item.id}</td><td>${item.nome}</td><td>${item.cnpj || ''}</td><td>${item.bairro}</td><td>${item.cidade}</td>`;
                html += `<td>
                    <button class="btn btn-sm btn-warning" onclick="editarItem('${tipo}', ${item.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger ml-1" onclick="excluirItem('${tipo}', ${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>`;
            } else if (tipo === 'precos') {
                const data = new Date(item.data_coleta).toLocaleString('pt-BR');
                html += `<td>${item.id}</td><td>${item.produto.nome}</td><td>${item.estabelecimento.nome}</td><td>R$ ${item.preco.toFixed(2)}</td><td>${data}</td>`;
                html += `<td>
                    <button class="btn btn-sm btn-warning" onclick="editarItem('${tipo}', ${item.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger ml-1" onclick="excluirItem('${tipo}', ${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>`;
            }
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        container.html(html);
    }

    let timeoutBusca = null;
    function filtrarListagem() {
        const busca = $('#busca').val().trim();
        const tipo = $('#tipoBusca').val();
        
        if (!tipo) return;
        
        if (timeoutBusca) {
            clearTimeout(timeoutBusca);
        }
        
        timeoutBusca = setTimeout(async () => {
            try {
                if (busca.length >= 2 || busca.length === 0) {
                    $('#listagemContainer').html('<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>');
                    await carregarListagemComBusca(tipo, busca);
                }
            } catch (error) {
                $('#listagemContainer').html('<div class="alert alert-danger">Erro na busca</div>');
            }
        }, 300);
    }

    async function editarItem(tipo, id) {
        try {
            let response, dados, item;
            
            if (tipo === 'precos') {
                response = await fetch('/precos');
                const data = await response.json();
                dados = data.precos || data;
                item = dados.find(d => d.id == id);
            } else {
                response = await fetch(`/${tipo}`);
                dados = await response.json();
                item = dados.find(d => d.id == id);
            }
            
            if (!item) {
                $(document).Toasts('create', {
                    class: 'bg-warning',
                    title: 'Aviso',
                    body: 'Item não encontrado',
                    autohide: true,
                    delay: 3000
                });
                return;
            }
            
            if (tipo === 'produtos') {
                $('#descricao').val(item.descricao);
                $('#ean').val(item.ean || '');
                $('#formProduto')[0].dataset.editId = id;
                $('#produtos-tab').tab('show');
            } else if (tipo === 'estabelecimentos') {
                $('#nome').val(item.nome);
                $('#cnpj').val(item.cnpj || '');
                $('#bairro').val(item.bairro || '');
                $('#cidade').val(item.cidade || '');
                $('#formEstabelecimento')[0].dataset.editId = id;
                $('#estabelecimentos-tab').tab('show');
            } else if (tipo === 'precos') {
                $('#produto_id').val(item.produto_id);
                $('#estabelecimento_id').val(item.estabelecimento_id);
                $('#preco').val(item.preco);
                $('#formPreco')[0].dataset.editId = id;
                $('#precos-tab').tab('show');
            }
        } catch (error) {
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro ao carregar dados para edição',
                autohide: true,
                delay: 5000
            });
        }
    }

    async function excluirItem(tipo, id) {
        if (!confirm('Tem certeza que deseja excluir este item?')) return;
        
        try {
            const response = await fetch(`/${tipo}/${id}`, { method: 'DELETE' });
            if (response.ok) {
                $(document).Toasts('create', {
                    class: 'bg-success',
                    title: 'Sucesso',
                    body: 'Item excluído com sucesso!',
                    autohide: true,
                    delay: 3000
                });
                carregarListagem();
            } else {
                $(document).Toasts('create', {
                    class: 'bg-danger',
                    title: 'Erro',
                    body: 'Erro ao excluir item',
                    autohide: true,
                    delay: 5000
                });
            }
        } catch (error) {
            $(document).Toasts('create', {
                class: 'bg-danger',
                title: 'Erro',
                body: 'Erro de conexão',
                autohide: true,
                delay: 5000
            });
        }
    }
</script>
</body>
</html>